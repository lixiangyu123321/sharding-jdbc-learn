input {
  # 接收来自 Filebeat 的日志
  # 使用默认的 beats codec，而不是 json codec
  # Filebeat 发送的是结构化数据，不是纯 JSON 字符串
  beats {
    port => 5044
  }
}

filter {
  # 解析 JSON 格式的日志（仅当 message 是 JSON 字符串时）
  if [fields][log_type] == "application" {
    # 尝试将 message 解析为 JSON（如果不是 JSON 格式会静默失败）
    json {
      source => "message"
      target => "parsed"
      skip_on_invalid_json => true
    }
    
    # 如果成功解析为 JSON，提取字段
    if [parsed] {
      mutate {
        add_field => { 
          "log_level" => "%{[parsed][level]}"
          "logger_name" => "%{[parsed][logger]}"
          "thread_name" => "%{[parsed][thread]}"
          "message_content" => "%{[parsed][message]}"
        }
        # 如果解析成功，移除原始 message（可选，保留也可以）
        # remove_field => [ "message" ]
      }
      
      # 解析时间戳（如果存在）
      if [parsed][timestamp] {
        date {
          match => [ "[parsed][timestamp]", "yyyy-MM-dd HH:mm:ss.SSS" ]
          target => "@timestamp"
        }
      }
    } else {
      # 如果不是 JSON 格式，将 message 作为普通文本日志处理
      # 可以尝试用 grok 解析常见的日志格式，或者保持原样
      mutate {
        add_field => {
          "message_content" => "%{message}"
        }
      }
    }
  }
  
  # 处理 Spring Boot 日志格式
  if [fields][log_type] == "spring-boot" {
    # 使用 grok 解析 Spring Boot 标准日志格式
    # 如果匹配失败，不会产生错误，只是不会提取字段
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[%{DATA:thread_name}\]%{SPACE}%{JAVACLASS:logger_name}%{SPACE}:%{SPACE}%{GREEDYDATA:message_content}"
      }
      tag_on_failure => []  # 匹配失败时不添加标签，避免产生警告
    }
    
    # 解析时间戳（如果 grok 成功提取了 timestamp 字段）
    if [timestamp] {
      date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
        target => "@timestamp"
      }
    }
    
    # 如果 grok 没有匹配成功，至少保留原始 message
    if ![message_content] {
      mutate {
        add_field => {
          "message_content" => "%{message}"
        }
      }
    }
  }
  
  # 处理错误日志
  if [log_level] == "ERROR" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  # 处理警告日志
  if [log_level] == "WARN" {
    mutate {
      add_tag => [ "warning" ]
    }
  }
  
  # 添加主机信息
  mutate {
    add_field => { 
      "host_ip" => "%{[host][ip]}"
      "host_name" => "%{[host][name]}"
    }
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["http://es-node1:9200", "http://es-node2:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    template_name => "logs"
    template => "/usr/share/logstash/templates/logs-template.json"
    template_overwrite => true
  }
  
  # 调试输出（可选，生产环境可注释）
  # stdout {
  #   codec => rubydebug
  # }
}

