input {
  # 接收来自 Filebeat 的日志
  beats {
    port => 5044
    codec => json
  }
}

filter {
  # 解析 JSON 格式的日志
  if [fields][log_type] == "application" {
    # 应用日志处理
    json {
      source => "message"
      target => "parsed"
    }
    
    # 解析时间戳
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
      target => "@timestamp"
    }
    
    # 添加字段
    mutate {
      add_field => { 
        "log_level" => "%{[parsed][level]}"
        "logger_name" => "%{[parsed][logger]}"
        "thread_name" => "%{[parsed][thread]}"
        "message_content" => "%{[parsed][message]}"
      }
    }
    
    # 移除原始 message（如果已解析）
    if [parsed] {
      mutate {
        remove_field => [ "message" ]
      }
    }
  }
  
  # 处理 Spring Boot 日志格式
  if [fields][log_type] == "spring-boot" {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[%{DATA:thread_name}\]%{SPACE}%{JAVACLASS:logger_name}%{SPACE}:%{SPACE}%{GREEDYDATA:message_content}"
      }
    }
    
    # 解析时间戳
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
      target => "@timestamp"
    }
  }
  
  # 处理错误日志
  if [log_level] == "ERROR" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  # 处理警告日志
  if [log_level] == "WARN" {
    mutate {
      add_tag => [ "warning" ]
    }
  }
  
  # 添加主机信息
  mutate {
    add_field => { 
      "host_ip" => "%{[host][ip]}"
      "host_name" => "%{[host][name]}"
    }
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["http://es-node1:9200", "http://es-node2:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    template_name => "logs"
    template => "/usr/share/logstash/templates/logs-template.json"
    template_overwrite => true
  }
  
  # 调试输出（可选，生产环境可注释）
  # stdout {
  #   codec => rubydebug
  # }
}

