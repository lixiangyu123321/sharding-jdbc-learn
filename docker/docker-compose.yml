
# 自定义网络
networks:
  docker-cluster-network:
    driver: bridge

# 数据卷（持久化目录按你的实际路径修改）
volumes:
  mysql-master-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\mysql\master  # 改为你的 Windows 本地目录
  mysql-slave-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\mysql\slave
  redis-data-1:  # node1 专属数据卷
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\redis\node1
  redis-data-2:  # node2 专属数据卷
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\redis\node2
  redis-data-3:  # node3 专属数据卷
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\redis\node3
  es-data-1:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\elasticsearch\node1
  es-data-2:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\elasticsearch\node2
  rabbitmq-data-1:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\rabbitmq\node1
  rabbitmq-data-2:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\rabbitmq\node2
  nacos-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\nacos
  kibana-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\kibana\kibana
  logstash-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\logstash
  filebeat-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: E:\docker-data\filebeat

services:
  # 1. MySQL 主库
  mysql-master:
    image: mysql:5.7
    container_name: mysql-master
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: test_db
      MYSQL_USER: test_user
      MYSQL_PASSWORD: 123456
      TZ: Asia/Shanghai
    command:
      --server-id=1
      --log-bin=mysql-bin
      --binlog-format=ROW
      --sync-binlog=1
      --innodb_flush_log_at_trx_commit=1
    volumes:
      - mysql-master-data:/var/lib/mysql
    privileged: true

  # 2. MySQL 从库
  mysql-slave:
    image: mysql:5.7
    container_name: mysql-slave
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "3308:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      TZ: Asia/Shanghai
    command:
      --server-id=2
      --log-bin=mysql-bin
      --binlog-format=ROW
      --read-only=1
    volumes:
      - mysql-slave-data:/var/lib/mysql
    privileged: true
    depends_on:
      - mysql-master

  # 3. Redis 节点1
  redis-node1:
    image: redis:6.2-alpine
    container_name: redis-node1
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "6379:6379"
      - "16379:16379"
    command: redis-server /etc/redis/redis.conf
    volumes:
      - redis-data-1:/data
      - ./redis.conf:/etc/redis/redis.conf  # 确保 redis.conf 在当前目录
    privileged: true

  # 4. Redis 节点2
  redis-node2:
    image: redis:6.2-alpine
    container_name: redis-node2
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "6380:6379"
      - "16380:16379"
    command: redis-server /etc/redis/redis.conf
    volumes:
      - redis-data-2:/data
      - ./redis.conf:/etc/redis/redis.conf
    privileged: true
    depends_on:
      - redis-node1

  # 5. Redis 节点3
  redis-node3:
    image: redis:6.2-alpine
    container_name: redis-node3
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "6381:6379"
      - "16381:16379"
    command: redis-server /etc/redis/redis.conf
    volumes:
      - redis-data-3:/data
      - ./redis.conf:/etc/redis/redis.conf
    privileged: true
    depends_on:
      - redis-node2

  # 6. ES 节点1
  es-node1:
    image: elasticsearch:7.17.9
    container_name: es-node1
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - node.name=es-node1
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es-node2
      - cluster.initial_master_nodes=es-node1,es-node2
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
      - xpack.monitoring.enabled=false
    volumes:
      - es-data-1:/usr/share/elasticsearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
    privileged: true

  # 7. ES 节点2
  es-node2:
    image: elasticsearch:7.17.9
    container_name: es-node2
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "9201:9200"
      - "9301:9300"
    environment:
      - node.name=es-node2
      - cluster.name=es-docker-cluster
      - discovery.seed_hosts=es-node1
      - cluster.initial_master_nodes=es-node1,es-node2
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
      - xpack.monitoring.enabled=false
    volumes:
      - es-data-2:/usr/share/elasticsearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
    privileged: true
    depends_on:
      - es-node1

  # 8. Kibana 服务
  kibana:
    image: kibana:7.17.9  # 版本必须和 ES 一致！
    container_name: kibana
    restart: always
    networks:
      - docker-cluster-network  # 和 ES 节点同网络，可通过容器名访问
    ports:
      - "5601:5601"  # Kibana 前端访问端口（固定 5601）
    volumes:
      - kibana-data:/usr/share/kibana/data  # 挂载数据目录而不是配置目录
      - ./kibaba/config/kibana.yml:/usr/share/kibana/config/kibana.yml:ro  # 挂载配置文件
    environment:
      # 配置 ES 集群地址（使用单个主节点，Kibana 会自动发现集群中的其他节点）
      - ELASTICSEARCH_HOSTS=http://es-node1:9200
      # 关闭安全认证（和 ES 保持一致，ES 关了这里也关）
      - xpack.security.enabled=false
      # 中文界面（可选，默认英文）
      - I18N_LOCALE=zh-CN
      # 服务器名称
      - SERVER_NAME=kibana
      # 服务器主机（允许外部访问）
      - SERVER_HOST=0.0.0.0
    depends_on:
      - es-node1
      - es-node2  # 保证 Kibana 在 ES 节点后启动

  # 9. Logstash 服务
  logstash:
    image: logstash:7.17.9  # 版本必须和 ES 一致！
    container_name: logstash
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "5044:5044"  # Beats 输入端口
      - "9600:9600"  # Logstash API 端口
    volumes:
      - logstash-data:/usr/share/logstash/data
      - ./logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ./logstash/templates:/usr/share/logstash/templates:ro
    environment:
      - LS_JAVA_OPTS=-Xmx512m -Xms512m
      - XPACK_MONITORING_ENABLED=false
    depends_on:
      - es-node1
      - es-node2

  # 10. Filebeat 服务
  filebeat:
    image: docker.elastic.co/beats/filebeat:7.17.9  # 版本必须和 ES 一致！
    container_name: filebeat
    restart: always
    user: root  # 需要 root 权限读取日志文件
    networks:
      - docker-cluster-network
    volumes:
      - filebeat-data:/usr/share/filebeat/data
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
      # 挂载应用日志目录（Windows 需要绝对路径）
      # Windows: 使用项目根目录的 logs 文件夹挂载到容器的 /var/log/app
      # Linux: 使用 /var/log/app 或项目目录下的 logs 文件夹
      - ../logs:/var/log/app:ro  # 挂载项目根目录下的 logs 文件夹
      - /var/lib/docker/containers:/var/lib/docker/containers:ro  # 可选：收集 Docker 容器日志
      - /var/run/docker.sock:/var/run/docker.sock:ro  # 可选：Docker API
    environment:
      - ELASTICSEARCH_HOSTS=http://es-node1:9200,http://es-node2:9200
      - LOGSTASH_HOSTS=logstash:5044
    # 修复配置文件权限问题（Filebeat 要求配置文件只能由所有者写入）
    # 由于 Windows 挂载的文件权限是 777，需要在启动前修复
    command: >
      sh -c "
        chmod 644 /usr/share/filebeat/filebeat.yml &&
        filebeat -e -strict.perms=false
      "
    depends_on:
      - logstash
      - es-node1
      - es-node2

  # 11. RabbitMQ 节点1
  rabbitmq-node1:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq-node1
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_ERLANG_COOKIE: "rabbitmq-cluster-cookie-123"
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: 123456
    volumes:
      - rabbitmq-data-1:/var/lib/rabbitmq
    privileged: true

  # 12. RabbitMQ 节点2
  rabbitmq-node2:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq-node2
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "5673:5672"
      - "15673:15672"
    environment:
      RABBITMQ_ERLANG_COOKIE: "rabbitmq-cluster-cookie-123"
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: 123456
    volumes:
      - rabbitmq-data-2:/var/lib/rabbitmq
    privileged: true
    depends_on:
      - rabbitmq-node1
  nacos:
    image: nacos/nacos-server:v2.3.2
    container_name: nacos
    restart: always
    networks:
      - docker-cluster-network
    ports:
      - "8848:8848"
      - "9848:9848"
    environment:
      - MODE=standalone
      - TZ=Asia/Shanghai
      - JVM_XMS=256m
      - JVM_XMX=256m
      # 注释所有 MySQL 相关环境变量，避免与 jdbc.properties 冲突
      # - SPRING_DATASOURCE_PLATFORM=mysql
      # - MYSQL_HOST=mysql-master
      # - MYSQL_PORT=3306
      # - MYSQL_USER=root
      # - MYSQL_PASSWORD=123456
      # - MYSQL_DB=nacos_config
    volumes:
      - nacos-data:/home/nacos/data
      - nacos-data:/home/nacos/logs
      - ./nacos-conf/jdbc.properties:/home/nacos/conf/jdbc.properties  # 核心：挂载自定义 jdbc.properties，覆盖内置配置
    privileged: true
    depends_on:
      - mysql-master
