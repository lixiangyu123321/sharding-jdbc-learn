# 日志中心集成完成说明

## 一、已完成的工作

### 1.1 配置文件集成

#### ✅ Logback 配置
- **位置**：`src/main/resources/logback-spring.xml`
- **功能**：
  - 控制台输出（开发环境）
  - 文件输出（所有日志）
  - 错误日志单独文件
  - JSON 格式输出（用于 Logstash 解析）
- **日志路径**：`/var/log/app/`（可通过环境变量 `LOG_HOME` 配置）

#### ✅ 应用配置
- **位置**：`src/main/resources/application.yaml`
- **新增配置**：
  ```yaml
  logging:
    config: classpath:logback-spring.xml
    level:
      root: INFO
      org.lix.mycatdemo: DEBUG
    file:
      path: ${LOG_HOME:/var/log/app}
  
  log:
    producer:
      enabled: ${LOG_PRODUCER_ENABLED:false}
  ```

### 1.2 代码组件集成

#### ✅ 日志服务（LogService）
- **位置**：`src/main/java/org/lix/mycatdemo/log/LogService.java`
- **功能**：
  - 业务操作日志记录
  - 性能日志记录
  - 审计日志记录
  - 追踪ID管理
  - MDC 上下文管理

#### ✅ 日志拦截器（LogInterceptor）
- **位置**：`src/main/java/org/lix/mycatdemo/log/LogInterceptor.java`
- **功能**：
  - 自动生成请求追踪ID
  - 记录请求开始和完成日志
  - 记录请求性能指标
  - 自动清理MDC上下文

#### ✅ 日志配置类（LogConfig）
- **位置**：`src/main/java/org/lix/mycatdemo/config/LogConfig.java`
- **功能**：
  - 注册日志拦截器
  - 启用定时任务支持

#### ✅ 日志生产者（LogProducer）
- **位置**：`src/main/java/org/lix/mycatdemo/log/LogProducer.java`
- **功能**：
  - 生成测试日志（可选，通过配置启用）
  - 模拟业务日志、用户操作日志、系统监控日志

#### ✅ 日志统计（LogStatistics）
- **位置**：`src/main/java/org/lix/mycatdemo/log/LogStatistics.java`
- **功能**：
  - 统计各级别日志数量
  - 定期打印统计信息

#### ✅ 增强的异常处理器
- **位置**：`src/main/java/org/lix/mycatdemo/exception/GlobalExceptionHandler.java`
- **改进**：
  - 记录详细的异常信息（包括请求路径、方法、追踪ID）
  - 自动生成请求追踪ID
  - 区分业务异常、通用异常和系统异常

### 1.3 Docker 服务配置

#### ✅ Elasticsearch
- 双节点集群配置
- 端口：9200, 9201

#### ✅ Logstash
- 配置文件：`docker/logstash/config/logstash.yml`
- 管道配置：`docker/logstash/pipeline/logstash.conf`
- 端口：5044（Beats输入）, 9600（API）

#### ✅ Filebeat
- 配置文件：`docker/filebeat/filebeat.yml`
- 日志路径：`/var/log/app/`

#### ✅ Kibana
- 端口：5601
- 中文界面支持

## 二、使用指南

### 2.1 启动服务

```bash
# 1. 启动 ELK 服务
cd docker
docker-compose up -d es-node1 es-node2 kibana logstash filebeat

# 2. 启动应用
mvn spring-boot:run
```

### 2.2 启用日志生产者（可选）

在 `application.yaml` 或环境变量中设置：

```yaml
log:
  producer:
    enabled: true
```

或通过环境变量：

```bash
export LOG_PRODUCER_ENABLED=true
```

### 2.3 使用日志服务

```java
@Autowired
private LogService logService;

// 记录业务操作
logService.logBusinessOperation("创建订单", "user001", orderId);

// 记录性能日志
logService.logPerformance("/api/orders", 150, true);

// 记录审计日志
logService.logAudit("DELETE", "/api/orders/123", "admin", "SUCCESS");
```

### 2.4 查看日志

#### 方式1：文件日志
- 所有日志：`/var/log/app/application.log`
- 错误日志：`/var/log/app/application-error.log`
- JSON日志：`/var/log/app/application-json.log`

#### 方式2：Kibana 可视化
1. 访问 `http://localhost:5601`
2. 创建索引模式：`logs-*`
3. 在 Discover 中查看日志
4. 创建可视化和仪表板

## 三、日志格式

### 3.1 标准格式

```
2026-01-20 10:30:45.123 [http-nio-8080-exec-1] INFO  o.l.m.controller.OrderController - 创建订单成功
```

### 3.2 JSON格式（用于 Logstash）

```json
{
  "timestamp": "2026-01-20T10:30:45.123+08:00",
  "level": "INFO",
  "logger": "org.lix.mycatdemo.controller.OrderController",
  "message": "创建订单成功",
  "thread": "http-nio-8080-exec-1",
  "traceId": "550e8400-e29b-41d4-a716-446655440000",
  "mdc": {
    "operation": "创建订单",
    "userId": "user001"
  }
}
```

## 四、关键特性

### 4.1 请求追踪

- 每个请求自动生成唯一的追踪ID
- 追踪ID通过 HTTP 头 `X-Request-Id` 传递
- 所有相关日志都包含相同的追踪ID，便于关联分析

### 4.2 MDC 上下文

- 支持在日志中添加上下文信息
- 自动清理，避免内存泄漏
- 便于日志过滤和查询

### 4.3 性能监控

- 自动记录每个请求的耗时
- 支持性能告警
- 便于性能分析和优化

### 4.4 异常追踪

- 详细的异常信息记录
- 包含请求上下文
- 便于问题定位和排查

## 五、注意事项

1. **日志路径权限**：确保应用有权限写入 `/var/log/app/` 目录
2. **日志轮转**：日志文件按天轮转，保留30天（错误日志90天）
3. **性能影响**：JSON 格式输出会增加少量性能开销
4. **追踪ID**：每个请求自动生成追踪ID，便于日志关联分析
5. **日志生产者**：默认关闭，需要测试时可通过配置启用

## 六、后续优化建议

1. **日志级别动态调整**：支持运行时调整日志级别
2. **日志采样**：高并发场景下支持日志采样
3. **告警机制**：集成告警系统，异常日志自动告警
4. **日志分析**：在 Kibana 中创建更多分析仪表板
5. **性能优化**：根据实际负载调整 Logstash 和 Filebeat 配置

---

**完成时间**：2026-01-20  
**版本**：v1.0

